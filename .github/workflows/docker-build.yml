name: Build & Push Docker Image + Upload Files to Blob

on:
  push:
    branches:
      - feature/test
      - main
  workflow_dispatch:

jobs:
  # --- Job 1: Build and Push Docker Image to ACR ---
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/feature/test'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” Log in to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}

      - name: ğŸ³ Build and Push Docker Image
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/rb_app:latest .
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/rb_app:latest

  # --- Job 2: Upload repo files to Azure Blob ---
  upload-to-blob:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”§ Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: ğŸª£ Ensure container exists
        run: |
          az storage container create \
            --name mycontainer \
            --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --public-access off

      - name: â¬†ï¸ Upload files to Azure Blob
        run: |
          az storage blob upload-batch \
            --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --destination mycontainer \
            --source . \
            --pattern "*" \
            --overwrite
